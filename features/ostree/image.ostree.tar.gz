#!/usr/bin/env bash

set -euo pipefail

input="$(realpath -- "$1")"
output="$(realpath -- "$2")"

OSTREE_REF="gardenlinux/today/$BUILDER_ARCH"

dir="$(mktemp -d)"
pushd "$dir" > /dev/null

export PATH="/builder/image.d:$PATH"

root_fs="$(mktemp -d)"
mount -t tmpfs tmpfs "$root_fs"
tar --extract --xattrs --xattrs-include '*' --directory "$root_fs" < "$input"

# make some changes to the root-fs to generate a different commit hash
echo 'echo hello world' > "$root_fs/bin/hello.sh"
chmod +x "$root_fs/bin/hello.sh"

repo="$(mktemp -d)"
ostree init --mode=archive --repo=$repo
ostree commit --repo=$repo --branch $OSTREE_REF --skip-if-unchanged -s "Automated commit $(date)" --no-xattrs $root_fs

pushd "$repo" > /dev/null

tar --create --mtime="@$BUILDER_TIMESTAMP" --sort name --numeric-owner --pax-option=exthdr.name=%d/PaxHeaders/%f,delete=atime,delete=ctime . | gzip > "$output"

popd > /dev/null
popd > /dev/null
# rm -rf "$dir"
# rm -rf "$root_fs"
# rm -rf "$repo"
